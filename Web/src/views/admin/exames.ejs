<%- include('../layouts/top', { active, title: 'HOME CARE — Exames / Prontuário' }) %>

<div class="lab-wrap">

  <!-- Pacientes (mock para demonstração) -->
  <aside class="lab-aside card">
    <h3>Pacientes</h3>
    <ul class="patient-list" id="patientList">
      <!-- preenchido pelo JS -->
    </ul>
    <div class="muted" style="margin-top:8px">* Lista mock apenas para fluxo front-end.</div>
  </aside>

  <!-- Área principal (últimos exames do paciente selecionado) -->
  <main class="lab-main">
    <div class="card">
      <div class="header-main">
        <div>
          <h2 id="pacName">Selecione um paciente</h2>
          <div class="muted" id="pacMeta">CPF — Idade — Sexo</div>
        </div>
        <button class="btn btn-primary" id="btnNovoExame" disabled>Novo exame</button>
      </div>
    </div>

    <div class="card">
      <h3>Exames recentes</h3>
      <div id="history" class="history"></div>
      <div class="muted">* Somente visual para teste (sem backend ainda).</div>
    </div>
  </main>
</div>

<!-- MODAL: novo exame -->
<div id="examModal" class="modal">
  <div class="modal__backdrop" data-close="1"></div>
  <div class="modal__content card">
    <div class="modal__head">
      <h3 id="modalTitle">Novo Exame</h3>
      <button class="btn btn--ghost" data-close="1">✕</button>
    </div>

    <div class="grid2">
      <div>
        <label class="lbl">Paciente</label>
        <div id="modalPac" class="muted"></div>
      </div>
      <div>
        <label class="lbl">Tipo de Exame</label>
        <select id="examSelect" class="input">
          <!-- opções injetadas no JS -->
        </select>
      </div>
    </div>

    <div class="table-wrap">
      <table id="paramsTable" class="table">
        <thead>
          <tr><th>Parâmetro</th><th style="width:160px">Resultado</th><th style="width:120px">Unidade</th><th>Referência</th></tr>
        </thead>
        <tbody><!-- linhas geradas no JS --></tbody>
      </table>
    </div>

    <div class="modal__foot">
      <button class="btn" data-close="1">Cancelar</button>
      <button class="btn btn-primary" id="btnGerarPdf">Salvar & Gerar PDF</button>
    </div>
  </div>
</div>

<style>
/* ---------- layout básico da página ---------- */
.lab-wrap{display:flex;gap:18px;padding:18px}
.card{border:1px solid #1e293b;background:#0b1220;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
.lab-aside{width:320px;min-width:280px}
.lab-main{flex:1;display:flex;flex-direction:column;gap:18px}
.header-main{display:flex;align-items:center;justify-content:space-between;gap:10px}
.patient-list{list-style:none;margin:8px 0 0;padding:0;display:flex;flex-direction:column;gap:10px}
.patient-item{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px;border:1px solid #1e293b;background:#0f172a;border-radius:10px}
.patient-item.active{outline:2px solid #2563eb}
.patient-item .meta{color:#94a3b8;font-size:12px}
.btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:transparent;color:#e6eef8;cursor:pointer}
.btn-primary{background:#2563eb;border-color:#2563eb}
.btn--ghost{background:transparent;border:0;color:#a6b4d1}
.muted{color:#9aa8c3;font-size:13px}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{border:1px solid #1e293b;padding:10px 12px;text-align:left}
.table th{background:#0f172a;color:#cbd5e1}
.input{width:100%;padding:7px 8px;border-radius:8px;border:1px solid #1e293b;background:#0f172a;color:#fff}
.lbl{display:block;margin-bottom:6px;color:#cbd5e1}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:12px 0}
.table-wrap{max-height:52vh;overflow:auto}
/* ---------- modal ---------- */
.modal{position:fixed;inset:0;display:none}
.modal.is-open{display:block}
.modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55)}
.modal__content{position:relative;max-width:980px;margin:40px auto}
.modal__head,.modal__foot{display:flex;align-items:center;justify-content:space-between;gap:10px}
.modal__foot{margin-top:14px}
.history{display:flex;flex-direction:column;gap:8px}
.history-item{padding:10px;border:1px solid #1e293b;border-radius:8px;background:#0f172a}
</style>

<script>
/* ===========================================================
   DEFINIÇÕES (TOP 10) — cada exame com seus parâmetros prontos
   =========================================================== */
var EXAMS = {
  hemograma: {
    titulo: 'Hemograma Completo',
    params: [
      { n: 'Hemácias', u: 'milhões/mm³', ref: '4.00 - 5.20', v: '' },
      { n: 'Hemoglobina', u: 'g/dL',       ref: '11.7 - 15.7', v: '' },
      { n: 'Hematócrito', u: '%',          ref: '36.0 - 47.0', v: '' },
      { n: 'VCM',         u: 'fL',         ref: '80 - 100',    v: '' },
      { n: 'HCM',         u: 'pg',         ref: '27 - 31',     v: '' },
      { n: 'CHCM',        u: 'g/dL',       ref: '31 - 36',     v: '' },
      { n: 'RDW',         u: '%',          ref: '11.5 - 14.5', v: '' },
      { n: 'Leucócitos',  u: '/mm³',       ref: '4.000 - 11.000', v: '' },
      { n: 'Plaquetas',   u: 'mil/mm³',    ref: '150 - 450',   v: '' }
    ]
  },
  perfil_lipidico: {
    titulo: 'Perfil Lipídico',
    params: [
      { n: 'Colesterol Total', u: 'mg/dL', ref: 'até 200', v: '' },
      { n: 'HDL',              u: 'mg/dL', ref: '> 40',    v: '' },
      { n: 'LDL',              u: 'mg/dL', ref: '< 130',   v: '' },
      { n: 'Triglicerídeos',   u: 'mg/dL', ref: '< 150',   v: '' }
    ]
  },
  glicose_jejum: {
    titulo: 'Glicemia em Jejum',
    params: [{ n: 'Glicemia', u: 'mg/dL', ref: '70 - 99', v: '' }]
  },
  hba1c: {
    titulo: 'Hemoglobina Glicada (HbA1c)',
    params: [{ n: 'HbA1c', u: '%', ref: '4.0 - 5.6', v: '' }]
  },
  funcao_renal: {
    titulo: 'Função Renal',
    params: [
      { n: 'Creatinina', u: 'mg/dL', ref: '0.6 - 1.3', v: '' },
      { n: 'Ureia',      u: 'mg/dL', ref: '15 - 45',   v: '' }
    ]
  },
  tireoide: {
    titulo: 'Função Tireoidiana',
    params: [
      { n: 'TSH',     u: 'µUI/mL', ref: '0.4 - 4.0', v: '' },
      { n: 'T4 Livre',u: 'ng/dL',  ref: '0.8 - 1.8', v: '' }
    ]
  },
  pcr: {
    titulo: 'Proteína C Reativa (PCR)',
    params: [{ n: 'PCR', u: 'mg/L', ref: '0 - 5', v: '' }]
  },
  dhl: {
    titulo: 'Desidrogenase Láctica (DHL)',
    params: [{ n: 'DHL', u: 'U/L', ref: '135 - 225', v: '' }]
  },
  transaminases: {
    titulo: 'Transaminases (Hepáticas)',
    params: [
      { n: 'ALT (TGP)', u: 'U/L', ref: '7 - 56',  v: '' },
      { n: 'AST (TGO)', u: 'U/L', ref: '10 - 40', v: '' }
    ]
  },
  ferritina: {
    titulo: 'Ferritina',
    params: [{ n: 'Ferritina', u: 'ng/mL', ref: '30 - 400', v: '' }]
  }
};

/* =========================
   MOCK de pacientes
   ========================= */
var PATIENTS = [
  { id: 1, nome: 'Maria Pereira',  cpf: '111.444.777-35', idade: 36, sexo: 'Feminino' },
  { id: 2, nome: 'Lucas Moraes',   cpf: '222.666.999-12', idade: 28, sexo: 'Masculino' },
  { id: 3, nome: 'Juliana Costa',  cpf: '333.555.888-44', idade: 41, sexo: 'Feminino' }
];

var selectedPatient = null;     // paciente atual
var currentExamKey = null;      // exame escolhido no modal
var currentParams   = [];       // params em edição
var historyByPac    = {};       // histórico mock em memória

/* =========================
   UI helpers
   ========================= */
function qs(s){ return document.querySelector(s); }
function qsa(s){ return document.querySelectorAll(s); }
function openModal(){ qs('#examModal').classList.add('is-open'); }
function closeModal(){ qs('#examModal').classList.remove('is-open'); }

/* =========================
   Render da lista de pacientes
   ========================= */
function renderPatients(){
  var ul = qs('#patientList'); ul.innerHTML = '';
  PATIENTS.forEach(function(p){
    var li = document.createElement('li');
    li.className = 'patient-item';
    li.innerHTML =
      '<div><div><strong>'+p.nome+'</strong></div>'+
      '<div class="meta">'+p.cpf+' — '+p.idade+' anos — '+p.sexo+'</div></div>'+
      '<button class="btn btn-primary btn-mini" data-id="'+p.id+'">Selecionar</button>';
    ul.appendChild(li);
  });
  ul.addEventListener('click', function(ev){
    if(ev.target && ev.target.dataset && ev.target.dataset.id){
      var pid = Number(ev.target.dataset.id);
      selectedPatient = PATIENTS.find(function(pp){return pp.id===pid;});
      qsa('.patient-item').forEach(function(el){ el.classList.remove('active'); });
      ev.target.closest('.patient-item').classList.add('active');
      qs('#pacName').textContent = selectedPatient.nome;
      qs('#pacMeta').textContent = selectedPatient.cpf+' — '+selectedPatient.idade+' anos — '+selectedPatient.sexo;
      qs('#btnNovoExame').disabled = false;
      renderHistory();
    }
  });
}

/* =========================
   Render histórico (mock)
   ========================= */
function renderHistory(){
  var wrap = qs('#history');
  wrap.innerHTML = '';
  if(!selectedPatient){ return; }
  var hist = historyByPac[selectedPatient.id] || [];
  if(hist.length===0){
    wrap.innerHTML = '<div class="muted">Sem exames cadastrados ainda.</div>';
    return;
  }
  hist.forEach(function(h){
    var div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = '<strong>'+h.titulo+'</strong> — '+h.data+'<br><span class="muted">'+h.resumo+'</span>';
    wrap.appendChild(div);
  });
}

/* =========================
   Preenche os selects e abre modal
   ========================= */
function openExamModal(){
  if(!selectedPatient){ alert('Selecione um paciente.'); return; }
  // preencher select
  var sel = qs('#examSelect'); sel.innerHTML = '';
  Object.keys(EXAMS).forEach(function(k){
    var opt = document.createElement('option');
    opt.value = k; opt.textContent = EXAMS[k].titulo;
    sel.appendChild(opt);
  });
  sel.value = 'hemograma';
  qs('#modalPac').textContent = selectedPatient.nome+' — '+selectedPatient.cpf;
  loadExam('hemograma');
  openModal();
}

/* =========================
   Carrega os parâmetros do exame escolhido
   ========================= */
function loadExam(key){
  currentExamKey = key;
  var def = EXAMS[key];
  currentParams = JSON.parse(JSON.stringify(def.params)); // cópia
  // título do modal
  qs('#modalTitle').textContent = 'Novo Exame — '+def.titulo;
  // tabela
  var tbody = qs('#paramsTable tbody'); tbody.innerHTML = '';
  currentParams.forEach(function(p, idx){
    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td>'+p.n+'</td>'+
      '<td><input class="input resinp" data-i="'+idx+'" placeholder="valor"></td>'+
      '<td>'+p.u+'</td>'+
      '<td>'+p.ref+'</td>';
    tbody.appendChild(tr);
  });
}

/* =========================
   Geração de PDF simples (sem template literal)
   ========================= */
function gerarPDF(){
  var def  = EXAMS[currentExamKey];
  var data = new Date();
  var dataStr = data.toLocaleString('pt-BR');
  var linhas = '';
  var resumo = [];

  var inputs = qsa('.resinp');
  inputs.forEach(function(inp){
    var i = Number(inp.getAttribute('data-i'));
    var val = (inp.value||'').trim();
    currentParams[i].v = val;
  });

  currentParams.forEach(function(p){
    var exib = (p.v ? p.v+' ' : '') + p.u;
    linhas += '<tr><td>'+p.n+'</td><td>'+ (p.v || '—') +'</td><td>'+p.u+'</td><td>'+p.ref+'</td></tr>';
    if(p.v){ resumo.push(p.n+': '+exib); }
  });

  // salva no histórico mock
  var h = { titulo: def.titulo, data: dataStr, resumo: resumo.slice(0,3).join(' | ')+(resumo.length>3?' ...':'') };
  if(!historyByPac[selectedPatient.id]) historyByPac[selectedPatient.id] = [];
  historyByPac[selectedPatient.id].unshift(h);
  renderHistory();

  // HTML do laudo (concatenado para evitar erro de template literal)
  var logo = '/public/images/logo_connected_health.png';
  var html = ''
  + '<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8"><title>Laudo</title>'
  + '<style>'
  + 'body{font-family:Arial,Helvetica,sans-serif;margin:32px;color:#111}'
  + '.hdr{display:flex;align-items:center;gap:12px;border-bottom:2px solid #ddd;padding-bottom:8px;margin-bottom:18px}'
  + '.hdr img{height:42px}'
  + 'h1{margin:0;font-size:20px}'
  + 'table{width:100%;border-collapse:collapse;margin-top:10px}'
  + 'th,td{border:1px solid #ddd;padding:8px;text-align:left;font-size:14px}'
  + 'th{background:#f3f4f6}'
  + '.muted{color:#6b7280;font-size:12px}'
  + '</style></head><body>'
  + '<div class="hdr"><img src="'+logo+'" alt="logo"><div><h1>Connect Health — Laudo Laboratorial</h1><div class="muted">Emitido em '+dataStr+'</div></div></div>'
  + '<h3>Paciente</h3>'
  + '<p><strong>'+selectedPatient.nome+'</strong><br>CPF: '+selectedPatient.cpf+'<br>Idade: '+selectedPatient.idade+' anos — Sexo: '+selectedPatient.sexo+'</p>'
  + '<h3>'+def.titulo+'</h3>'
  + '<table><thead><tr><th>Parâmetro</th><th>Resultado</th><th>Unidade</th><th>Referência</th></tr></thead>'
  + '<tbody>'+linhas+'</tbody></table>'
  + '<p class="muted" style="margin-top:18px">Responsável Técnico: Dra. Juliana Costa — CRBM 12345-SP</p>'
  + '<script>window.print()</'+'script>'
  + '</body></html>';

  var w = window.open('', '_blank');
  w.document.open();
  w.document.write(html);
  w.document.close();

  // fecha modal
  closeModal();
}

/* =========================
   Eventos
   ========================= */
document.addEventListener('DOMContentLoaded', function(){
  renderPatients();
  qs('#btnNovoExame').addEventListener('click', openExamModal);

  // change do select de exame
  qs('#examSelect').addEventListener('change', function(){
    loadExam(this.value);
  });

  // abrir/fechar modal
  document.body.addEventListener('click', function(ev){
    if(ev.target && ev.target.dataset && ev.target.dataset.close){ closeModal(); }
  });
  qs('#btnGerarPdf').addEventListener('click', gerarPDF);
});
</script>

<%- include('../layouts/bottom') %>
