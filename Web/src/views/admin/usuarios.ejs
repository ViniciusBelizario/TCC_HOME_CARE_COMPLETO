<!--src\views\admin\usuarios.ejs-->
<%- include('../layouts/top', { 
  active, 
  title: 'Connect Health ‚Äî Usu√°rios',
  pageCss: ['/public/css/admin_css/pages/usuarios.css'] 
}) %>

<div class="toolbar">
  <div class="search-section">
    <input type="text" id="searchInput" class="input" placeholder="Buscar por nome, CPF ou e-mail">
    <button class="btn" id="searchBtn">Buscar</button>
  </div>

  <a href="/admin/usuarios/novo" class="btn btn-primary" id="btnNovoUsuario">+ Novo Usu√°rio</a>
</div>

<!-- LISTAGEM DE USU√ÅRIOS -->
<div id="resultContainer" class="card">
  <table class="table" id="userTable">
    <thead>
      <tr>
        <th>Nome</th>
        <th>CPF</th>
        <th>E-mail</th>
        <th>Papel</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="userTableBody">
  <% if (users && users.length > 0) { %>
    <% users.forEach(u => { %>
      <tr>
        <td><%= u.name %></td>
        <td><%= u.cpf %></td>
        <td><%= u.email %></td>
        <td><%= u.role %></td>
        <td>
          <button class="btn btn-outline btn-small" data-id="<%= u.id %>">Prontu√°rio</button>
        </td>
      </tr>
    <% }) %>
  <% } else { %>
    <tr>
      <td colspan="5" style="text-align:center; color:#aaa;">Nenhum usu√°rio encontrado.</td>
    </tr>
  <% } %>
</tbody>
  </table>
</div>

<!-- MODAL: NOVO USU√ÅRIO (come√ßa escondido de verdade) -->
<div id="modalUsuario" class="modal hidden" style="display:none !important;">
  <div class="modal-content">
    <h2>Cadastrar Novo Usu√°rio</h2>
    <form id="formNovoUsuario">
      <div class="form-grid">
        <input type="text" name="nome" placeholder="Nome completo" required>
        <input type="text" name="telefone" placeholder="Telefone">
        <input type="text" name="cpf" id="cpfInput" placeholder="CPF" required maxlength="14">
        <input type="text" name="cep" id="cepInput" placeholder="CEP" maxlength="8">
        <input type="text" name="endereco" id="enderecoInput" placeholder="Endere√ßo">
        <select name="sexo" required>
          <option value="">Selecione o sexo</option>
          <option>Masculino</option>
          <option>Feminino</option>
        </select>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <button type="button" class="btn btn-outline" id="fecharModalUsuario">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: PRONTU√ÅRIO (come√ßa escondido tamb√©m) -->
<div id="modalProntuario" class="modal hidden" style="display:none !important;">
  <div class="modal-content">
    <h2>Prontu√°rio do Paciente</h2>
    <div class="prontuario-info">
      <p><strong>Nome:</strong> Maria Pereira</p>
      <p><strong>Idade:</strong> 36 anos</p>
      <p><strong>√öltimo Atendimento:</strong> 27/04/2024 ‚Äî Avalia√ß√£o com Dr. Juliana Costa</p>
      <h4>Exames Recentes</h4>
      <ul>
        <li>Exame de sangue ‚Äî 12/04/2024</li>
        <li>Resson√¢ncia ‚Äî 10/02/2024</li>
      </ul>
    </div>

    <div class="form-actions" style="margin-top:15px; justify-content:space-between;">
      <div>
        <button class="btn btn-primary">üìÑ Baixar PDF</button>
        <button class="btn btn-outline">üñ®Ô∏è Imprimir</button>
      </div>
      <button class="btn btn-outline" id="fecharModalProntuario">Fechar</button>
    </div>
  </div>
</div>

<%- include('../layouts/bottom') %>

<!-- ============================= -->
<!--  SCRIPT DIRETO NO ARQUIVO     -->
<!-- ============================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modalUsuario = document.getElementById('modalUsuario');
  const modalProntuario = document.getElementById('modalProntuario');
  const btnNovoUsuario = document.getElementById('btnNovoUsuario');
  const btnVerProntuario = document.getElementById('btnVerProntuario');
  const fecharModalUsuario = document.getElementById('fecharModalUsuario');
  const fecharModalProntuario = document.getElementById('fecharModalProntuario');
  const formNovoUsuario = document.getElementById('formNovoUsuario');
  const cpfInput = document.getElementById('cpfInput');
  const cepInput = document.getElementById('cepInput');
  const enderecoInput = document.getElementById('enderecoInput');

  // Fun√ß√£o gen√©rica pra abrir e fechar modais com fade
  const abrirModal = (modal) => {
    modal.style.display = 'flex';
    modal.classList.remove('hidden');
  };
  const fecharModal = (modal) => {
    modal.classList.add('hidden');
    setTimeout(() => { modal.style.display = 'none'; }, 150);
  };

  // Eventos
  btnNovoUsuario.addEventListener('click', () => abrirModal(modalUsuario));
  fecharModalUsuario.addEventListener('click', () => fecharModal(modalUsuario));
  btnVerProntuario.addEventListener('click', () => abrirModal(modalProntuario));
  fecharModalProntuario.addEventListener('click', () => fecharModal(modalProntuario));

  // M√°scara CPF
  cpfInput.addEventListener('input', () => {
    cpfInput.value = cpfInput.value
      .replace(/\D/g, '')
      .replace(/(\d{3})(\d)/, '$1.$2')
      .replace(/(\d{3})(\d)/, '$1.$2')
      .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  });

  // Fake auto preenchimento por CEP
  cepInput.addEventListener('input', () => {
    if (cepInput.value.length === 8) {
      enderecoInput.value = 'Rua Exemplo, Bairro Central - Cidade Modelo';
    }
  });

  // Fake salvar usu√°rio
  formNovoUsuario.addEventListener('submit', e => {
    e.preventDefault();
    alert('Usu√°rio cadastrado com sucesso (simula√ß√£o)');
    fecharModal(modalUsuario);
  });
});


document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');

  searchBtn.addEventListener('click', () => {
    const q = searchInput.value.trim();
    const url = q ? `/admin/usuarios?q=${encodeURIComponent(q)}` : '/admin/usuarios';
    window.location.href = url;
  });
});
</script>
