<!-- src/views/layouts/top.ejs -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= typeof title !== 'undefined' ? title : 'HOME CARE â€” Admin' %></title>

  <!-- CSS base + tela especÃ­fica -->
  <link rel="stylesheet" href="/public/css/base/reset.css" />
  <link rel="stylesheet" href="/public/css/base/variables.css" />
  <link rel="stylesheet" href="/public/css/base/typography.css" />
  <link rel="stylesheet" href="/public/css/utilities/helpers.css" />

  <!-- Admin layout/componentes -->
  <link rel="stylesheet" href="/public/css/admin_css/layout/layout_base.css" />
  <link rel="stylesheet" href="/public/css/admin_css/layout/sidebar.css" />
  <link rel="stylesheet" href="/public/css/admin_css/layout/topbar.css" />
  <link rel="stylesheet" href="/public/css/admin_css/layout/grid.css" />
  <link rel="stylesheet" href="/public/css/admin_css/components/buttons.css" />
  <link rel="stylesheet" href="/public/css/admin_css/components/cards.css" />
  <link rel="stylesheet" href="/public/css/admin_css/components/table.css" />
  <link rel="stylesheet" href="/public/css/admin_css/components/search.css" />
  <link rel="stylesheet" href="/public/css/admin_css/components/lists.css" />

  <% if (typeof pageCss !== 'undefined' && Array.isArray(pageCss)) { pageCss.forEach(href => { %>
    <link rel="stylesheet" href="<%= href %>" />
  <% }) } %>
</head>
<body class="dark">
<%
  // ---- Fallbacks seguros para evitar ReferenceError nas includes ----
  const __user = typeof user !== 'undefined' && user ? user : (typeof locals !== 'undefined' && locals.user ? locals.user : null);
  const __role = (__user && __user.role && String(__user.role).toUpperCase()) || null;

  const __isAdmin = (typeof isAdmin !== 'undefined') ? !!isAdmin : (__role === 'ADMIN');
  const __isAtendente = (typeof isAtendente !== 'undefined') ? !!isAtendente : (__role === 'ATENDENTE');
  const __isMedico = (typeof isMedico !== 'undefined') ? !!isMedico : (__role === 'MEDICO');
  const __active = (typeof active !== 'undefined') ? active : '';
%>

<div class="app">
  <aside class="sidebar">
    <div class="sidebar__brand">
      <span class="brand-mini">Admin</span>
    </div>

    <nav class="menu">
      <a href="/admin/dashboard" class="menu__item <%= __active==='dashboard' ? 'active' : '' %>">
        <span class="ico">â–£</span> Dashboards
      </a>

      <% if (__isAtendente) { %>
        <a href="/admin/usuarios" class="menu__item <%= __active==='users' ? 'active' : '' %>">
          <span class="ico">ðŸ‘¤</span> UsuÃ¡rios
        </a>
      <% } %>

      <% if (__isAtendente || __isMedico) { %>
        <a href="/admin/agendamentos" class="menu__item <%= __active==='appointments' ? 'active' : '' %>">
          <span class="ico">â–¦</span> Agendamentos
        </a>
        <a href="/admin/exames" class="menu__item <%= __active==='exams' ? 'active' : '' %>">
          <span class="ico"></span> 
        </a>
      <% } %>

      <% if (__isAdmin) { %>
  <a href="/admin/relatorios" class="menu__item <%= __active==='reports' ? 'active' : '' %>">
    <span class="ico">â–¸</span> RelatÃ³rios
  </a>
<% } %>
    </nav>
  </aside>

  <main class="main">
    <header class="topbar">
      <div class="topbar__left">
        <img src="/public/images/logo_connected_health.png" alt="Connect Health" class="topbar__logo" />
      </div>

      <div class="topbar__right">
        <% if (__user) { %>
          <span class="muted"><strong><%= __user.name || 'UsuÃ¡rio' %></strong> â€” <%= __role || 'â€”' %></span>
        <% } %>

        <form method="POST" action="/auth/logout" style="margin-left:12px;">
          <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <% } %>
          <button class="btn btn--outline">Sair</button>
        </form>
      </div>
    </header>

    <section class="view is-visible">
