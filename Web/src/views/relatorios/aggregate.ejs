<%- include('../layouts/top', { active: 'reports', title: 'Relatórios — Agregado' }) %>

<div class="card" style="max-width:1080px;margin:0 auto;">
  <h3>Agregado por período</h3>

  <form method="GET" action="/admin/relatorios/agregado" class="form" style="display:grid;gap:10px;margin-bottom:12px;">
  <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr;">
    <select class="input" name="granularity">
      <option value="hour" <%= filters.granularity==='hour'?'selected':'' %>>hora</option>
      <option value="day"  <%= filters.granularity==='day'?'selected':'' %>>dia</option>
      <option value="week" <%= filters.granularity==='week'?'selected':'' %>>semana</option>
      <option value="month"<%= filters.granularity==='month'?'selected':'' %>>mês</option>
    </select>
    <input class="input" type="text" name="tz" value="<%= filters.tz || 'America/Sao_Paulo' %>" placeholder="Timezone (IANA)" />
    <input class="input" type="text" name="doctorId" value="<%= filters.doctorId || '' %>" placeholder="ID do médico (opcional)" />
  </div>
  <div class="form-grid" style="grid-template-columns:1fr 1fr;">
    <input class="input" type="datetime-local" name="from" value="<%= filters.from || '' %>" required />
    <input class="input" type="datetime-local" name="to"   value="<%= filters.to   || '' %>" required />
  </div>
  <div class="form-actions" style="justify-content:flex-end;">
    <a class="btn" href="/admin/relatorios">Voltar</a>
    <button class="btn btn-primary" type="submit">Gerar</button>
  </div>
</form>

  <% if (error) { %>
  <p class="msg-error">
    <%= error %>
    <br>
    <small class="muted">
      Dica: se o erro citar <code>serviceId</code> ou coluna inexistente, tente
      gerar sem o filtro de serviço (deixe em branco). Também já enviamos
      <code>service_id</code> automaticamente para compatibilidade.
    </small>
  </p>
<% } %>


  <% if (data && data.length) { %>
    <div class="card" style="overflow:auto;">
      <table class="table">
        <thead>
          <tr>
            <% Object.keys(data[0]).forEach(k => { %><th><%= k %></th><% }) %>
          </tr>
        </thead>
        <tbody>
          <% data.forEach(row => { %>
            <tr>
              <% Object.keys(data[0]).forEach(k => { %><td><%= row[k] %></td><% }) %>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else if (!error && typeof data !== 'undefined') { %>
    <p class="muted">Nenhum dado para o intervalo informado.</p>
  <% } %>
</div>

<%- include('../layouts/bottom') %>
